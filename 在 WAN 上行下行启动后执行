#!/bin/sh

### Custom user script
### Called after internal WAN up/down action
### $1 - WAN action (up/down)
### $2 - WAN interface name (e.g. eth3 or ppp0)
### $3 - WAN IPv4 address

### --- Config SmartDNS Start ---
# 获取脚本的执行程序路径和参数
script_name=$0
action=$1
interface=$2
script_params="$@"
logger "在 WAN 上行/下行启动后执行:"
logger "脚本启动: $script_name，参数: $script_params"

# --- 定义更新广告规则的函数 ---
updateadrule() {
    logger "开始执行 SmartDNS 规则更新..."

    # 检测 SmartDNS 是否存在
    if ! pidof smartdns >/dev/null 2>&1; then
        logger "SmartDNS 未运行，跳过更新。"
        return
    fi

    # 等待网络
    until ping -c 1 223.5.5.5 >/dev/null 2>&1; do sleep 1; done

    # 下载新规则到临时文件
    TMP_RULE="/opt/etc/smartdns/anti-ad-new.conf"
    TARGET_RULE="/opt/etc/smartdns/anti-ad-smartdns.conf"

    if /opt/libexec/wget-ssl https://v6.gh-proxy.org/https://raw.githubusercontent.com/privacy-protection-tools/anti-AD/master/anti-ad-smartdns.conf \
        -O "$TMP_RULE" --no-check-certificate; then

        logger "规则下载成功，正在验证..."

        # 验证新规则是否可用 (使用 check 模式)
        # 注意：这里假设主配置文件已经包含了 conf-file 路径
        # 我们临时创建一个验证用的主配置，或者直接相信下载的文件
        # 为了稳妥，我们直接覆盖文件并重载服务，如果失败SmartDNS通常会报错但保持运行

        mv "$TMP_RULE" "$TARGET_RULE"

        # 重启 SmartDNS
        killall smartdns
        /opt/sbin/smartdns -c /opt/etc/smartdns/smartdns.conf -p /opt/var/run/smartdns.pid &
        logger "SmartDNS 规则已更新并重启服务"

    else
        logger "规则下载失败，保持原有规则"
        rm -f "$TMP_RULE"
    fi
}

# --- 处理 WAN 动作 ---
if [ "$action" = "up" ] && [ "$interface" = "ppp0" ]; then
    logger "WAN Up: 检查网络连接..."
    if ! ping -c 10 223.5.5.5 >/dev/null 2>&1; then
        logger "网络不通，尝试重启 WAN..."
        # 注意：restart_wan 可能导致脚本再次触发，注意死循环，通常 ping 不通才重启
        # restart_wan
        # exit
    else
        logger "WAN Up: 网络正常"

        # 使用 until 循环等待网络恢复
        until ping -c 1 223.5.5.5 >/dev/null 2>&1; do
            sleep 1
        done

        # 重启 DHCPD
        restart_dhcpd

        # 如果 SmartDNS 进程存在，更新 DNS 配置
        if pidof smartdns >/dev/null 2>&1; then
            cp /etc/dnsmasq.conf /opt/etc/dnsmasq.conf
            sed -i '/cache-size=/d' /opt/etc/dnsmasq.conf
            sed -i '/no-resolv/d' /opt/etc/dnsmasq.conf
            sed -i '/no-hosts/d' /opt/etc/dnsmasq.conf
            sed -i '/server=/d' /opt/etc/dnsmasq.conf
            cat >>/opt/etc/dnsmasq.conf <<"EOF"
no-resolv
no-hosts
cache-size=0
server=127.0.0.1#60053
EOF
            killall dnsmasq
            dnsmasq -C /opt/etc/dnsmasq.conf &
        else
            # 如果 SmartDNS 挂了，这里可以尝试重启它，或者保持默认 dnsmasq 确保能上网
            logger "dnsmasq以默认参数运行中"
        fi
    fi
fi

# --- 处理手动/定时更新动作 ---
if [ "$action" = "updateadrule" ]; then
    updateadrule
fi
### --- Config SmartDNS End ---
