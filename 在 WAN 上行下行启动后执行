#!/bin/sh

### Custom user script
### Called after internal WAN up/down action
### $1 - WAN action (up/down)
### $2 - WAN interface name (e.g. eth3 or ppp0)
### $3 - WAN IPv4 address

### --- Config SmartDNS Start ---
# 获取脚本的执行程序路径和参数
script_name=$0
action=$1
interface=$2
script_params="$@"
logger "SmartDNS WAN 脚本启动: $script_name，参数: $script_params"

# 加载函数库
if [ -f /tmp/.smartdns_install_complete ]; then
    source /tmp/smartdns_lib.sh
else
    logger "SmartDNS WAN: 启动脚本未完成"
    exit 1
fi

# -----------------------------------
# 场景 A: WAN 口启动 (up)
# -----------------------------------
if [ "$action" = "up" ] && [ "$interface" = "ppp0" ]; then
    logger "SmartDNS WAN: WAN ($interface) Up 发现"

    # 1. 检查网络连通性
    count=0
    # 设置最大尝试次数 5 次，每次 5 s
    max_retries=5

    while [ $count -lt $max_retries ]; do
        if check_network; then
            logger "SmartDNS WAN: 网络连接校验通过"
            break
        fi

        count=$((count + 1))
        # logger "WAN: 等待网络连通... ($count/$max_retries)" # 可选：不想刷屏日志就注释掉
        sleep 5
    done

    if [ $count -ge $max_retries ]; then
        logger "SmartDNS WAN: 警告 - 超过 $max_retries 次尝试网络仍不通，放弃配置 SmartDNS。"
        exit 1
    fi

    # 2. 检查 SmartDNS 是否存活
    if ! pidof smartdns >/dev/null; then
        logger "SmartDNS WAN: SmartDNS 未运行，尝试重新启动..."
        /opt/sbin/smartdns -c /opt/etc/smartdns/smartdns.conf &
        sleep 2
    fi

    # 3. 强制刷新 DNSMasq 配置 (防止 WAN 重连后 dnsmasq 被系统重置)
    link_dnsmasq
fi

# -----------------------------------
# 场景 B: 手动/定时更新规则 (updateadrule)
# -----------------------------------
if [ "$action" = "updateadrule" ]; then
    update_ad_rule
fi
### --- Config SmartDNS End ---
