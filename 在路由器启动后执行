#!/bin/sh

### Custom user script
### Called after startup

### --- Config SmartDNS Start ---
logger "脚本启动: 开始部署 SmartDNS"

# 1. 检查网络
until ping -c 1 223.5.5.5 >/dev/null 2>&1; do sleep 1; done
logger "Internet已接通"

# 2. 使用镜像加速安装 Entware 环境
if [ ! -f /opt/bin/opkg ]; then
  mount -t tmpfs tmpfs /opt -o size=48M
  for folder in bin etc lib/opkg tmp var/lock var/run; do
    mkdir -p /opt/$folder
  done

  # 使用镜像下载 opkg
  wget http://mirror.nju.edu.cn/entware/mipselsf-k3.4/installer/opkg -O /opt/bin/opkg
  chmod 755 /opt/bin/opkg
  # 配置 opkg 镜像源
  wget http://mirror.nju.edu.cn/entware/mipselsf-k3.4/installer/opkg.conf -O /opt/etc/opkg.conf
  sed -i 's|bin.entware.net|mirror.nju.edu.cn/entware|g' /opt/etc/opkg.conf

  # 初始化环境
  /opt/bin/opkg update
  chmod 777 /opt/tmp
  for file in passwd group shells shadow; do
    [ -f /etc/$file ] && cp /etc/$file /opt/etc/$file
  done
  [ -f /etc/TZ ] && cp /etc/TZ /opt/etc/TZ
  logger "Entware 运行环境创建完成"
fi

# 3. 安装 SmartDNS 及其依赖
/opt/bin/opkg install smartdns wget-ssl ca-certificates

# 4. 生成 SmartDNS 主配置文件
# 注意：移除了 google dns，移除了 hardcode 的规则路径，改为引用
mkdir -p /opt/etc/smartdns
cat >/opt/etc/smartdns/smartdns.conf <<"EOF"
user nobody
server-name smartdns
restart-on-crash yes
log-level notice
log-size 128K
bind [::]:60053
force-qtype-SOA 65

# 上游服务器
server-https https://223.5.5.5/dns-query
server-https https://223.6.6.6/dns-query
server-https https://1.12.12.12/dns-query
server-https https://120.53.53.53/dns-query
server-https https://doh.360.cn/dns-query
server-https https://1.0.0.1/dns-query
server-https https://doh-pure.onedns.net/dns-query

# 引用广告规则文件
conf-file /opt/etc/smartdns/anti-ad-smartdns.conf
EOF

# 5. 下载/更新广告规则
logger "正在下载广告过滤规则..."
/opt/libexec/wget-ssl https://v6.gh-proxy.org/https://raw.githubusercontent.com/privacy-protection-tools/anti-AD/master/anti-ad-smartdns.conf -O /opt/etc/smartdns/anti-ad-smartdns.conf --no-check-certificate
logger "广告过滤规则下载成功"

# 6. 启动 SmartDNS
killall smartdns 2>/dev/null
/opt/sbin/smartdns -c /opt/etc/smartdns/smartdns.conf -p /opt/var/run/smartdns.pid &

# 等待 SmartDNS 启动
sleep 2

# 7. 接管 DNSMasq
# 如果smartdns启动失败,dnsmasq继续以默认配置运行
if pidof smartdns >/dev/null; then
  logger "SmartDNS 启动成功，准备接管 DNSMasq"
  # 复制并修改 DNSMasq 配置
  cp /etc/dnsmasq.conf /opt/etc/dnsmasq.conf
  sed -i '/cache-size=/d' /opt/etc/dnsmasq.conf
  sed -i '/no-resolv/d' /opt/etc/dnsmasq.conf
  sed -i '/no-hosts/d' /opt/etc/dnsmasq.conf
  sed -i '/server=/d' /opt/etc/dnsmasq.conf
  # 修改 dnsmasq 配置：
  # - 禁用本地解析和缓存
  # - 设置查询端口为 65353
  # - 将所有 DNS 查询转发到 SmartDNS (127.0.0.1:60053)
  cat >>/opt/etc/dnsmasq.conf <<"EOF"
no-resolv
no-hosts
cache-size=0
server=127.0.0.1#60053
EOF

  # 重启 DNSMasq
  killall dnsmasq
  dnsmasq -C /opt/etc/dnsmasq.conf &
  logger "DNSMasq 已重启并转发至 SmartDNS"
else
  logger "SmartDNS 启动失败! DNSMasq 保持默认配置"
fi
### --- Config SmartDNS End ---
